name: Customer Website CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: ["*"]

jobs:
  test-and-build:
    name: ðŸ§ª Test and Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.10.0 # Explicitly use a newer version compatible with Sharp
          cache: "npm"
          cache-dependency-path: "./customer-front-website/package-lock.json" # Point to the lock file

      - name: Display Node.js version
        run: |
          node -v
          npm -v

      - name: Install dependencies
        working-directory: ./customer-front-website
        run: npm ci --legacy-peer-deps

      - name: Run linting
        working-directory: ./customer-front-website
        run: npm run lint

      # Create a temporary layout file without next/font
      - name: Create temp layout without next/font
        run: |
          cd customer-front-website
          # Back up the original layout file
          cp app/layout.tsx app/layout.tsx.original
          # Create a modified version without next/font
          cat > app/layout.tsx << 'EOL'
          import type { Metadata } from "next";
          import "./_styles/globals.css";
          import Header from "@/app/_components/Header";

          export const metadata: Metadata = {
            title: {
              template: "%s | The Wild Oasis",
              default: "Welcome | The Wild Oasis",
            },
            description:
              "Luxurious cabin hotel, located in the heart of the Italian Dolomites," +
              "surrounded by beautiful mountains and dark forests",
          };

          // preventing accidental property modifications on the props object
          type RootLayoutProps = Readonly<{
            children: React.ReactNode;
          }>;

          function RootLayout(props: RootLayoutProps) {
            return (
              <html lang="en">
                <body
                  className="bg-primary-950 text-primary-100 min-h-screen 
                    flex flex-col antialiased"
                >
                  <Header />
                  <div className="flex-1 px-8 py-12 grid">
                    <main className="max-w-7xl mx-auto w-full">{props.children}</main>
                  </div>
                </body>
              </html>
            );
          }

          export default RootLayout;
          EOL

      # Temporarily remove babel.config.js for the build
      - name: Remove babel config for build
        run: |
          cd customer-front-website
          if [ -f babel.config.js ]; then
            mv babel.config.js babel.config.js.bak
            echo "Backed up babel.config.js"
          fi

      # Install sharp
      - name: Install Sharp
        run: |
          cd customer-front-website
          npm install sharp@latest

      # Run tests with Jest
      - name: Run tests
        working-directory: ./customer-front-website
        run: npm test

      # Build the Next.js application
      - name: Build Next.js application
        working-directory: ./customer-front-website
        run: npm run build

      # Restore original files after build
      - name: Restore original files
        run: |
          cd customer-front-website
          # Restore layout
          if [ -f app/layout.tsx.original ]; then
            mv app/layout.tsx.original app/layout.tsx
            echo "Restored original layout.tsx"
          fi
          # Restore babel config
          if [ -f babel.config.js.bak ]; then
            mv babel.config.js.bak babel.config.js
            echo "Restored babel.config.js"
          fi

      # Build Storybook
      - name: Build Storybook
        working-directory: ./customer-front-website
        run: npm run build-storybook
